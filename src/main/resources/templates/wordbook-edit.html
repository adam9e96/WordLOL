<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>단어장 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="data:;base64,ivborw0kggo=" rel="icon">
</head>
<body class="bg-light">

<div th:replace="~{fragments/header :: header}"></div>

<!-- 토스트 메시지 -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div aria-atomic="true" aria-live="assertive" class="toast" id="toast" role="alert">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2"></i>
            <strong class="me-auto">알림</strong>
            <button class="btn-close" data-bs-dismiss="toast" type="button"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<div class="container mt-4">
    <div class="card">
        <div class="card-body">
            <h2 class="card-title mb-4">
                <i class="bi bi-pencil-square me-2"></i>단어장 수정
            </h2>

            <form class="needs-validation" id="wordBookForm" novalidate>
                <input type="hidden" id="wordBookId" th:value="${wordBookId}">

                <!-- 단어장 기본 정보 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label" for="name">단어장 이름</label>
                            <input class="form-control" id="name" required type="text">
                            <div class="invalid-feedback">단어장 이름을 입력해주세요.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label" for="category">카테고리</label>
                            <select class="form-select" id="category" required>
                                <option value="TOEIC">토익</option>
                                <option value="TOEFL">토플</option>
                                <option value="CSAT">수능</option>
                                <option value="CUSTOM">사용자 정의</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label" for="description">설명</label>
                    <textarea class="form-control" id="description" required rows="2"></textarea>
                    <div class="invalid-feedback">설명을 입력해주세요.</div>
                </div>

                <!-- 단어 목록 -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">단어 목록</h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="addWordRow()" type="button">
                                <i class="bi bi-plus-lg me-1"></i>단어 추가
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="wordList">
                            <!-- 단어 목록이 여기에 동적으로 추가됩니다 -->
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <button class="btn btn-secondary" onclick="history.back()" type="button">
                        <i class="bi bi-arrow-left me-2"></i>뒤로 가기
                    </button>
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-check-lg me-2"></i>저장하기
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const toast = new bootstrap.Toast(document.getElementById('toast'));
    const wordBookId = document.getElementById('wordBookId').value;

    function showToast(message, type = 'success') {
        const toastElement = document.getElementById('toast');
        const toastBody = toastElement.querySelector('.toast-body');
        toastBody.textContent = message;
        toastElement.classList.remove('bg-success', 'bg-danger');
        toastElement.classList.add(`bg-${type}`);
        toast.show();
    }

    // 단어장 데이터 로드
    async function loadWordBook(wordBookId) {
        try {
            // 1. 단어장 기본 정보 조회
            const wordBookResponse = await fetch(`/api/v1/wordbooks/${wordBookId}`);
            if (!wordBookResponse.ok) {
                throw new Error('단어장을 찾을 수 없습니다.');
            }
            const wordBook = await wordBookResponse.json();

            // 2. 단어장의 단어 목록 조회
            const wordsResponse = await fetch(`/api/v1/wordbooks/words/${wordBookId}`);
            if (!wordsResponse.ok) {
                throw new Error('단어 목록을 불러올 수 없습니다.');
            }
            const words = await wordsResponse.json();

            // UI 업데이트
            document.getElementById('name').value = wordBook.name;
            document.getElementById('description').value = wordBook.description;
            document.getElementById('category').value = wordBook.category;


            // 단어 목록 표시
            const wordList = document.getElementById('wordList');
            wordList.innerHTML = '';
            words.forEach((word) => {
                addWordRow(word);
                console.log(word);
            })

            // wordBook.words.forEach(word => addWordRow(word));
        } catch (error) {
            console.error('Error:', error);
            showToast('단어장 로딩 중 오류가 발생했습니다.', 'danger');
        }
    }

    function addWordRow(word = null) {
        const wordList = document.getElementById('wordList');
        const row = document.createElement('div');
        row.className = 'word-row mb-3';

        row.innerHTML = `
        <div class="row">
            <input type="hidden" class="word-id" value="${word ? word.id : ''}">
            <div class="col-md-3">
                <input type="text" class="form-control vocabulary"
                       value="${word ? word.vocabulary : ''}"
                       placeholder="영단어" required>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control vocabulary"
                       value="${word ? word.vocabulary : ''}"
                       placeholder="영단어" required>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control meaning"
                       value="${word ? word.meaning : ''}"
                       placeholder="의미" required>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control hint"
                       value="${word ? word.hint || '' : ''}"
                       placeholder="힌트">
            </div>
            <div class="col-md-2">
                <select class="form-select difficulty">
                    <option value="1" ${word && word.difficulty === 1 ? 'selected' : ''}>Level 1</option>
                    <option value="2" ${word && word.difficulty === 2 ? 'selected' : ''}>Level 2</option>
                    <option value="3" ${word && word.difficulty === 3 ? 'selected' : ''}>Level 3</option>
                    <option value="4" ${word && word.difficulty === 4 ? 'selected' : ''}>Level 4</option>
                    <option value="5" ${word && word.difficulty === 5 ? 'selected' : ''}>Level 5</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('.word-row').remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;

        wordList.appendChild(row);
    }

    // 폼 제출 처리
    document.getElementById('wordBookForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!e.target.checkValidity()) {
            e.stopPropagation();
            e.target.classList.add('was-validated');
            showToast('필수 항목을 모두 입력해주세요.', 'danger');
            return;
        }

        const wordRows = document.querySelectorAll('.word-row');
        const words = Array.from(wordRows).map(row => ({
            id: row.querySelector('.word-id').value || null,  // ID 추가
            vocabulary: row.querySelector('.vocabulary').value.trim(),
            meaning: row.querySelector('.meaning').value.trim(),
            hint: row.querySelector('.hint').value.trim(),
            difficulty: parseInt(row.querySelector('.difficulty').value)
        }));


        const wordBookData = {
            name: document.getElementById('name').value.trim(),
            description: document.getElementById('description').value.trim(),
            category: document.getElementById('category').value,
            words: words
        };

        try {
            const response = await fetch(`/api/v1/wordbooks/${wordBookId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(wordBookData)
            });

            if (response.ok) {
                showToast('단어장이 성공적으로 수정되었습니다.');
                setTimeout(() => {
                    window.location.href = '/word/wordbook-list';
                }, 1500);
            } else {
                const error = await response.json();
                showToast(error.message || '단어장 수정 중 오류가 발생했습니다.', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('서버와의 통신 중 오류가 발생했습니다.', 'danger');
        }
    });

    // 초기 데이터 로드
    loadWordBook(wordBookId);
</script>
</body>
</html>